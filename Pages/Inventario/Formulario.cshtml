@page "{handler?}/{id:int?}"
@model FormularioModel
@{
    ViewData["Title"] = Model.Modo == "Crear" ? "Nuevo Equipo" :
                        Model.Modo == "Editar" ? "Editar Equipo" : "Ver Equipo";
    Layout = "_LayoutGeneral";

    bool esModoLectura = Model.Modo == "Ver";
}

<div class="container-form">
    <h1 class="beige-text"><i class="fas fa-laptop"></i> @ViewData["Title"]</h1>

    <div class="row">
        <!-- Columna izquierda (formulario) -->
        <div class="col-md-6">
            <form method="post" class="form-beige">
                <input type="hidden" asp-for="Equipo.IdActivoFijo" />
                <input type="hidden" id="modeloId" value="@Model.Equipo.IdModelo" />

                <div class="form-group">
                    <label asp-for="Equipo.NumeroSerie" class="form-label">Numero de Serie</label>
                    <input asp-for="Equipo.NumeroSerie" class="form-control" readonly="@esModoLectura" />
                    <span asp-validation-for="Equipo.NumeroSerie" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="Equipo.EtiquetaInv" class="form-label"></label>
                    <input asp-for="Equipo.EtiquetaInv" class="form-control" readonly="@esModoLectura" />
                    <span asp-validation-for="Equipo.EtiquetaInv" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="Equipo.IdTipoEquipo" class="form-label">Tipo de Equipo</label>
                    <select asp-for="Equipo.IdTipoEquipo" class="form-control input-beige"
                            id="tipoEquipo" disabled="@(Model.Modo == "Ver")">
                        <option value="">-- Seleccione un tipo --</option>
                        @foreach (var tipo in Model.TiposEquipos)
                        {
                            <option value="@tipo.Id"
                                    selected="@(tipo.Id == Model.Equipo?.IdTipoEquipo)">
                                @tipo.Nombre
                            </option>
                        }
                    </select>
                    <span asp-validation-for="Equipo.IdTipoEquipo" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="Equipo.IdMarca" class="form-label">Marca</label>
                    <select asp-for="Equipo.IdMarca" class="form-control input-beige" id="marca">
                        @if (Model.Equipo?.IdMarca.HasValue == true && Model.Marcas?.Any() == true)
                        {
                            <option value="@Model.Equipo.IdMarca" selected>
                                @Model.Marcas.First(m => m.Id == Model.Equipo.IdMarca).Nombre
                            </option>
                        }
                        else
                        {
                            <option value="">-- Seleccione un tipo primero --</option>
                        }
                    </select>
                    <span asp-validation-for="Equipo.IdMarca" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="Equipo.IdModelo" class="form-label">Modelo</label>
                    <select asp-for="Equipo.IdModelo" class="form-control input-beige" id="modelo">
                        @if (Model.Equipo?.IdModelo > 0 && Model.Modelos?.Any() == true)
                        {
                            <option value="@Model.Equipo.IdModelo" selected>
                                @Model.Modelos.First(m => m.Id == Model.Equipo.IdModelo).Nombre
                            </option>
                        }
                        else
                        {
                            <option value="">-- Seleccione una marca primero --</option>
                        }
                    </select>
                    <span asp-validation-for="Equipo.IdModelo" class="text-danger"></span>
                </div>

                <!-- Nuevo campo para selección de perfil -->
                <div class="form-group">
                    <label asp-for="Equipo.IdPerfil" class="form-label">Perfil del Modelo</label>
                    <select asp-for="Equipo.IdPerfil" class="form-control input-beige" id="perfil"
                            disabled="@(Model.Modo == "Ver")">
                        @if (Model.Perfiles?.Any() == true)
                        {
                            <option value="@Model.Equipo.IdPerfil" selected>
                                @Model.Perfiles.First(m => m.Id == Model.Equipo.IdPerfil).Nombre
                            </option>
                        }
                        else
                        {
                            <option value="">-- No hay perfiles disponibles --</option>
                        }
                    </select>
                    <span asp-validation-for="Equipo.IdPerfil" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="Equipo.FechaCompra" class="form-label"></label>
                    <input asp-for="Equipo.FechaCompra" type="date" class="form-control" readonly="@esModoLectura">
                    <span asp-validation-for="Equipo.FechaCompra" class="text-danger"></span>
                </div>

                <div class="form-group">
                    <label asp-for="Equipo.Garantia" class="form-label"></label>
                    <input asp-for="Equipo.Garantia" class="form-control" readonly="@esModoLectura" />
                    <span asp-validation-for="Equipo.Garantia" class="text-danger"></span>
                </div>

                <input type="hidden" asp-for="Equipo.IdEstado" />

                @if (!esModoLectura)
                {
                    <div class="form-actions">
                        <button type="submit" class="btn btn-beige">Guardar</button>
                        <a href="/Inventario" class="btn btn-cancelar">Cancelar</a>
                    </div>
                }
                else
                {
                    <div class="form-actions">
                        <a href="/Inventario/Editar/@Model.Equipo.IdActivoFijo" class="btn btn-beige">Editar</a>
                        <a href="/Inventario" class="btn btn-cancelar">Volver</a>
                    </div>
                }
            </form>
        </div>

        <!-- Columna derecha (características) -->
        <div class="col-md-6">
            <div class="card caracteristicas-card">
                <div class="card-header">
                    <h5>Características del Perfil</h5>
                </div>
                <div class="card-body" id="caracteristicas-container">
                    @if (Model.Equipo?.IdPerfil > 0)
                    {
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin"></i> Cargando características...
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">Seleccione un perfil para ver sus características</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const esModoLectura = '@Model.Modo' === 'Ver';
            const perfilSelect = document.getElementById('perfil');

            // Configurar eventos para los dropdowns
            if (!esModoLectura) {
                document.getElementById('tipoEquipo').addEventListener('change', cargarMarcas);
                document.getElementById('marca').addEventListener('change', cargarModelos);
                document.getElementById('modelo').addEventListener('change', cargarPerfiles);
                perfilSelect.addEventListener('change', function () {
                    cargarCaracteristicas(this.value);
                });
            }

            // Cargar datos iniciales
            if (document.getElementById('tipoEquipo').value) {
                cargarMarcas();
            }

            // Si es modo lectura, cargar características del perfil seleccionado
            if (esModoLectura && perfilSelect.value) {
                cargarCaracteristicas(perfilSelect.value);
            }

            async function cargarPerfiles() {
                const modeloId = document.getElementById('modelo').value;
                const perfilDropdown = document.getElementById('perfil');

                if (!modeloId) {
                    perfilDropdown.innerHTML = '<option value="">-- Seleccione un modelo primero --</option>';
                    perfilDropdown.disabled = true;
                    return;
                }

                try {
                    perfilDropdown.innerHTML = '<option value="">Cargando perfiles...</option>';
                    perfilDropdown.disabled = true;

                    const response = await fetch(`/Inventario/Formulario?handler=PerfilesPorModelo&modeloId=${modeloId}`);
                    if (!response.ok) throw new Error('Error en la respuesta');

                    const perfiles = await response.json();

                    const perfilIdActual = @(Model.Equipo?.IdPerfil ?? 0);
                    let options = '<option value="">-- Seleccione un perfil --</option>';

                    perfiles.forEach(perfil => {
                        const selected = perfil.id == perfilIdActual ? 'selected' : '';
                        options += `<option value="${perfil.id}" ${selected}>${perfil.nombre}</option>`;
                    });

                    perfilDropdown.innerHTML = options;
                    perfilDropdown.disabled = false;

                    // Si hay un perfil seleccionado, cargar sus características
                    if (perfilSelect.value) {
                        cargarCaracteristicas(perfilSelect.value);
                    }
                } catch (error) {
                    console.error('Error cargando perfiles:', error);
                    perfilDropdown.innerHTML = '<option value="">-- Error cargando perfiles --</option>';
                    perfilDropdown.disabled = false;
                }
            }

            async function cargarCaracteristicas(perfilId) {
                const container = document.getElementById('caracteristicas-container');

                if (!perfilId) {
                    container.innerHTML = '<p class="text-muted">Seleccione un perfil para ver sus características</p>';
                    return;
                }

                try {
                    container.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando...</div>';

                    const response = await fetch(`/Inventario/Formulario?handler=CaracteristicasPorPerfil&perfilId=${perfilId}`);
                    if (!response.ok) throw new Error('Error en la respuesta');

                    const caracteristicas = await response.json();

                    if (caracteristicas.length > 0) {
                        let html = '<ul class="list-group">';
                        caracteristicas.forEach(car => {
                            html += `<li class="list-group-item"><strong>${car.Nombre}:</strong> ${car.Valor}</li>`;
                        });
                        html += '</ul>';
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<p class="text-muted">No se encontraron características para este perfil</p>';
                    }
                } catch (error) {
                    console.error('Error cargando características:', error);
                    container.innerHTML = '<p class="text-danger">Error al cargar características</p>';
                }
            }

            // Funciones para cargar marcas y modelos
            async function cargarMarcas() {
                const tipoId = document.getElementById('tipoEquipo').value;
                const marcaDropdown = document.getElementById('marca');
                const modeloDropdown = document.getElementById('modelo');
                const perfilDropdown = document.getElementById('perfil');

                if (!tipoId) {
                    resetDropdown(marcaDropdown, '-- Seleccione un tipo primero --');
                    resetDropdown(modeloDropdown, '-- Seleccione una marca primero --');
                    resetDropdown(perfilDropdown, '-- Seleccione un modelo primero --');
                    return;
                }

                try {
                    showLoading(marcaDropdown);
                    resetDropdown(modeloDropdown, '-- Seleccione una marca primero --');
                    resetDropdown(perfilDropdown, '-- Seleccione un modelo primero --');

                    const response = await fetch(`/Inventario/Formulario?handler=MarcasPorTipo&tipoId=${tipoId}`);
                    if (!response.ok) throw new Error('Error en la respuesta');

                    const marcas = await response.json();
                    populateDropdown(marcaDropdown, marcas, '-- Seleccione una marca --', @(Model.Equipo?.IdMarca ?? 0));

                } catch (error) {
                    console.error('Error cargando marcas:', error);
                    resetDropdown(marcaDropdown, '-- Error cargando marcas --');
                }
            }

            async function cargarModelos() {
                const marcaId = document.getElementById('marca').value;
                const tipoId = document.getElementById('tipoEquipo').value;
                const modeloDropdown = document.getElementById('modelo');
                const perfilDropdown = document.getElementById('perfil');

                if (!marcaId || !tipoId) {
                    resetDropdown(modeloDropdown, '-- Seleccione marca y tipo --');
                    resetDropdown(perfilDropdown, '-- Seleccione un modelo primero --');
                    return;
                }

                try {
                    showLoading(modeloDropdown);
                    resetDropdown(perfilDropdown, '-- Seleccione un modelo primero --');

                    const response = await fetch(`/Inventario/Formulario?handler=ModelosPorMarcaYTipo&marcaId=${marcaId}&tipoId=${tipoId}`);
                    if (!response.ok) throw new Error('Error en la respuesta');

                    const modelos = await response.json();
                    populateDropdown(modeloDropdown, modelos, '-- Seleccione un modelo --', @(Model.Equipo?.IdModelo ?? 0));

                    // Cargar perfiles si hay un modelo seleccionado
                    if (modeloDropdown.value) {
                        cargarPerfiles();
                    }
                } catch (error) {
                    console.error('Error cargando modelos:', error);
                    resetDropdown(modeloDropdown, '-- Error cargando modelos --');
                }
            }

            async function cargarCaracteristicas(perfilId) {
                const container = document.getElementById('caracteristicas-container');

                if (!perfilId) {
                    container.innerHTML = '<p class="text-muted">Seleccione un perfil para ver sus características</p>';
                    return;
                }

                try {
                    container.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Cargando...</div>';

                    const response = await fetch(`/Inventario/Formulario?handler=CaracteristicasPorPerfil&perfilId=${perfilId}`);
                    if (!response.ok) throw new Error('Error en la respuesta');

                    const caracteristicas = await response.json();
                    console.log('Características recibidas:', caracteristicas); // Para depuración

                    if (caracteristicas.length > 0) {
                        let html = '<ul class="list-group">';
                        caracteristicas.forEach(car => {
                            html += `<li class="list-group-item"><strong>${car.nombre}:</strong> ${car.valor}</li>`;
                        });
                        html += '</ul>';
                        container.innerHTML = html;
                    } else {
                        container.innerHTML = '<p class="text-muted">No se encontraron características para este perfil</p>';
                    }
                } catch (error) {
                    console.error('Error cargando características:', error);
                    container.innerHTML = '<p class="text-danger">Error al cargar características</p>';
                }
            }

            function populateDropdown(dropdown, items, defaultText, selectedValue) {
                let options = `<option value="">${defaultText}</option>`;

                items.forEach(item => {
                    const selected = item.id == selectedValue ? 'selected' : '';
                    options += `<option value="${item.id}" ${selected}>${item.nombre}</option>`;
                });

                dropdown.innerHTML = options;
                dropdown.disabled = false;
            }

            function resetDropdown(dropdown, message) {
                dropdown.innerHTML = `<option value="">${message}</option>`;
                dropdown.disabled = true;
            }

            function showLoading(dropdown) {
                dropdown.innerHTML = '<option value="">Cargando...</option>';
                dropdown.disabled = true;
            }
        });
    </script>
}