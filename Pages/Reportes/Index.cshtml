@page
@model InventarioComputo.Pages.Reportes.ReportesModel
@{
    ViewData["Title"] = "Reportes";
    Layout = "_LayoutGeneral";
}

<div class="container mt-3">
    <h3>Generación de Reportes</h3>

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger">@TempData["Error"]</div>
    }
    @if (TempData["Mensaje"] != null)
    {
        <div class="alert alert-success">@TempData["Mensaje"]</div>
    }

    <form id="frmReportes" method="get" class="border p-3 rounded bg-light">
        <div class="row g-3 align-items-end">

            <!-- Sección -->
            <div class="col-md-4">
                <label class="form-label">Sección</label>
                @{
                    var selAF = Model.Seccion == "ActivosFijos" ? "selected" : null;
                    var selAsig = Model.Seccion == "Asignaciones" ? "selected" : null;
                    var selBit = Model.Seccion == "Bitacora" ? "selected" : null;
                    var selEmp = Model.Seccion == "Empleados" ? "selected" : null;
                    var selMant = Model.Seccion == "Mantenimientos" ? "selected" : null;
                    var selUsr = Model.Seccion == "Usuarios" ? "selected" : null;
                }
                <select class="form-select" id="seccion" name="Seccion" onchange="onSeccionChange(); loadPreview()">
                    <option value="">-- Seleccione --</option>
                    <option value="ActivosFijos" selected="@selAF">Activos Fijos</option>
                    <option value="Asignaciones" selected="@selAsig">Asignaciones</option>
                    <option value="Bitacora" selected="@selBit">Bitácora</option>
                    <option value="Empleados" selected="@selEmp">Empleados</option>
                    <option value="Mantenimientos" selected="@selMant">Mantenimientos</option>
                    <option value="Usuarios" selected="@selUsr">Usuarios</option>
                </select>
            </div>

            <!-- ========= BLOQUES DE FILTROS ========= -->
            <!-- Activos Fijos -->
            <div class="col-md-8 filtro-bloque" id="filtros-af" style="display:none;">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Departamento</label>
                        <select class="form-select" name="IdDepartamento" data-for="ActivosFijos" onchange="loadPreview()">
                            <option value="">Todos</option>
                            @foreach (var d in Model.Departamentos)
                            {
                                var sel = Model.IdDepartamento == d.Id ? "selected" : null;
                                <option value="@d.Id" selected="@sel">@d.Nombre</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-4">
                        <label class="form-label">Modelo</label>
                        <select class="form-select" name="IdModelo" data-for="ActivosFijos" onchange="loadPreview()">
                            <option value="">Todos</option>
                            @foreach (var m in Model.Modelos)
                            {
                                var sel = Model.IdModelo == m.Id ? "selected" : null;
                                <option value="@m.Id" selected="@sel">@m.Nombre</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-8">
                        <label class="form-label">Búsqueda (EtiquetaInv / S/N)</label>
                        <input type="text" class="form-control" name="TextoBusqueda" data-for="ActivosFijos"
                               value="@Model.TextoBusqueda" onblur="loadPreview()" />
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">Fecha Compra (Desde)</label>
                        <input type="date" class="form-control" name="FechaCompraInicio" data-for="ActivosFijos"
                               value="@(Model.FechaCompraInicio?.ToString("yyyy-MM-dd"))" onchange="loadPreview()" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Fecha Compra (Hasta)</label>
                        <input type="date" class="form-control" name="FechaCompraFin" data-for="ActivosFijos"
                               value="@(Model.FechaCompraFin?.ToString("yyyy-MM-dd"))" onchange="loadPreview()" />
                    </div>
                </div>
            </div>

            <!-- Asignaciones -->
            <div class="col-md-8 filtro-bloque" id="filtros-asig" style="display:none;">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Departamento</label>
                        <select class="form-select" name="IdDepartamento" data-for="Asignaciones" onchange="loadPreview()">
                            <option value="">Todos</option>
                            @foreach (var d in Model.Departamentos)
                            {
                                var sel = Model.IdDepartamento == d.Id ? "selected" : null;
                                <option value="@d.Id" selected="@sel">@d.Nombre</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Fecha (Desde)</label>
                        <input type="date" class="form-control" name="FechaInicio" data-for="Asignaciones"
                               value="@(Model.FechaInicio?.ToString("yyyy-MM-dd"))" onchange="loadPreview()" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Fecha (Hasta)</label>
                        <input type="date" class="form-control" name="FechaFin" data-for="Asignaciones"
                               value="@(Model.FechaFin?.ToString("yyyy-MM-dd"))" onchange="loadPreview()" />
                    </div>
                </div>
            </div>

            <!-- Bitácora -->
            <div class="col-md-8 filtro-bloque" id="filtros-bit" style="display:none;">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Desde</label>
                        <input type="date" class="form-control" name="FechaInicio" data-for="Bitacora"
                               value="@(Model.FechaInicio?.ToString("yyyy-MM-dd"))" onchange="loadPreview()" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Hasta</label>
                        <input type="date" class="form-control" name="FechaFin" data-for="Bitacora"
                               value="@(Model.FechaFin?.ToString("yyyy-MM-dd"))" onchange="loadPreview()" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Texto (usuario / detalles)</label>
                        <input type="text" class="form-control" name="TextoBusqueda" data-for="Bitacora"
                               value="@Model.TextoBusqueda" onblur="loadPreview()" />
                    </div>
                </div>
            </div>

            <!-- Empleados -->
            <div class="col-md-8 filtro-bloque" id="filtros-emp" style="display:none;">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label">Departamento</label>
                        <select class="form-select" name="IdDepartamento" data-for="Empleados" onchange="loadPreview()">
                            <option value="">Todos</option>
                            @foreach (var d in Model.Departamentos)
                            {
                                var sel = Model.IdDepartamento == d.Id ? "selected" : null;
                                <option value="@d.Id" selected="@sel">@d.Nombre</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-8">
                        <label class="form-label">Búsqueda (Nombre / Email)</label>
                        <input type="text" class="form-control" name="TextoBusqueda" data-for="Empleados"
                               value="@Model.TextoBusqueda" onblur="loadPreview()" />
                    </div>
                </div>
            </div>

            <!-- Mantenimientos -->
            <div class="col-md-8 filtro-bloque" id="filtros-mant" style="display:none;">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Desde</label>
                        <input type="date" class="form-control" name="FechaInicio" data-for="Mantenimientos"
                               value="@(Model.FechaInicio?.ToString("yyyy-MM-dd"))" onchange="loadPreview()" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Hasta</label>
                        <input type="date" class="form-control" name="FechaFin" data-for="Mantenimientos"
                               value="@(Model.FechaFin?.ToString("yyyy-MM-dd"))" onchange="loadPreview()" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Equipo (AF)</label>
                        <select class="form-select" name="IdEquipo" data-for="Mantenimientos" onchange="loadPreview()">
                            <option value="">Todos</option>
                            @foreach (var eq in Model.Equipos)
                            {
                                var sel = Model.IdEquipo == eq.Id ? "selected" : null;
                                <option value="@eq.Id" selected="@sel">@eq.EtiquetaInv - @eq.NumeroSerie</option>
                            }
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Técnico</label>
                        <select class="form-select" name="IdTecnico" data-for="Mantenimientos" onchange="loadPreview()">
                            <option value="">Todos</option>
                            @foreach (var t in Model.Tecnicos)
                            {
                                var sel = Model.IdTecnico == t.Id ? "selected" : null;
                                <option value="@t.Id" selected="@sel">@t.Nombre</option>
                            }
                        </select>
                    </div>
                </div>
            </div>

            <!-- Usuarios -->
            <div class="col-md-8 filtro-bloque" id="filtros-usr" style="display:none;">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Búsqueda (Usuario / Empleado)</label>
                        <input type="text" class="form-control" name="TextoBusqueda" data-for="Usuarios"
                               value="@Model.TextoBusqueda" onblur="loadPreview()" />
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Rol</label>
                        <select class="form-select" name="IdRol" data-for="Usuarios" onchange="loadPreview()">
                            <option value="">Todos</option>
                            @foreach (var r in Model.Roles)
                            {
                                var sel = Model.IdRol == r.Id ? "selected" : null;
                                <option value="@r.Id" selected="@sel">@r.Nombre</option>
                            }
                        </select>
                    </div>
                </div>
            </div>

            <!-- Botones: izquierda descargas / derecha preview+limpiar -->
            <div class="col-12 mt-3">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <div class="d-flex flex-wrap gap-3">
                        <button type="button" class="btn btn-warning" onclick="descargar('PDF')">Descargar PDF</button>
                        <button type="button" class="btn btn-success" onclick="descargar('EXCELOPENXML')">Descargar Excel</button>
                        <button type="button" class="btn btn-primary" onclick="descargar('WORDOPENXML')">Descargar Word</button>
                    </div>
                    <div class="d-flex flex-wrap gap-3">
                        <button type="button" class="btn btn-secondary" onclick="loadPreview()">Previsualizar</button>
                        <button type="button" class="btn btn-outline-secondary" onclick="limpiarFiltros()">Limpiar</button>
                    </div>
                </div>
            </div>

            <!-- Preview -->
            <div class="col-12 mt-3">
                <iframe id="previewFrame" title="Preview" style="width:100%; height:600px; border:1px solid #ccc;"></iframe>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        const filtrosPorSeccion = {
            "ActivosFijos": ["IdDepartamento", "IdModelo", "TextoBusqueda", "FechaCompraInicio", "FechaCompraFin"],
            "Asignaciones": ["IdDepartamento", "FechaInicio", "FechaFin"],
            "Bitacora": ["FechaInicio", "FechaFin", "TextoBusqueda"],
            "Empleados": ["IdDepartamento", "TextoBusqueda"],
            "Mantenimientos": ["FechaInicio", "FechaFin", "IdEquipo", "IdTecnico"],
            "Usuarios": ["TextoBusqueda", "IdRol"]
        };

        function showBlock(id, visible) {
            const el = document.getElementById(id);
            if (!el) return;
            el.style.display = visible ? '' : 'none';
        }

        function onSeccionChange() {
            const s = document.getElementById('seccion').value;

            showBlock('filtros-af', false);
            showBlock('filtros-asig', false);
            showBlock('filtros-bit', false);
            showBlock('filtros-emp', false);
            showBlock('filtros-mant', false);
            showBlock('filtros-usr', false);

            if (s === 'ActivosFijos') showBlock('filtros-af', true);
            if (s === 'Asignaciones') showBlock('filtros-asig', true);
            if (s === 'Bitacora') showBlock('filtros-bit', true);
            if (s === 'Empleados') showBlock('filtros-emp', true);
            if (s === 'Mantenimientos') showBlock('filtros-mant', true);
            if (s === 'Usuarios') showBlock('filtros-usr', true);

            marcarNoActivos(s);
        }

        function marcarNoActivos(seccion) {
            const f = document.getElementById('frmReportes');
            const activos = new Set((filtrosPorSeccion[seccion] || []).map(s => s.toLowerCase()));

            f.querySelectorAll('input[name], select[name]').forEach(el => {
                const nameLower = (el.name || '').toLowerCase();

                if (nameLower === 'seccion' || nameLower === 'formato' || nameLower === 'handler' || nameLower === 'debug' || el.id === 'seccion')
                    return;

                el.disabled = !activos.has(nameLower);
            });
        }

        function currentFilterBlock() {
            const seccion = document.getElementById('seccion').value;
            const map = {
                "ActivosFijos": "filtros-af",
                "Asignaciones": "filtros-asig",
                "Bitacora": "filtros-bit",
                "Empleados": "filtros-emp",
                "Mantenimientos": "filtros-mant",
                "Usuarios": "filtros-usr"
            };
            return document.getElementById(map[seccion]);
        }

        function buildParams() {
            const params = new URLSearchParams();
            const seccion = document.getElementById('seccion').value;
            if (!seccion) return null;
            params.set('Seccion', seccion);

            const block = currentFilterBlock();
            if (block) {
                block.querySelectorAll('input[name]:not([disabled]),select[name]:not([disabled])').forEach(el => {
                    const v = (el.value || '').trim();
                    if (v) params.set(el.name, v);
                });
            }
            return params;
        }

        function buildPreviewUrl() {
            const params = buildParams();
            if (!params) return null;
            params.set('handler', 'Preview');
            return `${window.location.pathname}?${params.toString()}`;
        }

        function buildDownloadUrl(formato) {
            const params = buildParams();
            if (!params) return null;
            params.set('handler', 'Generar');
            if (formato) params.set('formato', formato);
            return `${window.location.pathname}?${params.toString()}`;
        }

        function loadPreview() {
            const seccion = document.getElementById('seccion').value;
            if (!seccion) return;
            marcarNoActivos(seccion);
            const url = buildPreviewUrl();
            if (url) document.getElementById('previewFrame').src = url;
        }

        function descargar(formato) {
            const seccion = document.getElementById('seccion').value;
            if (!seccion) { alert('Seleccione una sección.'); return; }
            marcarNoActivos(seccion);
            const url = buildDownloadUrl(formato);
            if (url) window.location.href = url;
        }

        function limpiarFiltros() {
            const seccion = document.getElementById('seccion').value;
            if (!seccion) return;

            const block = currentFilterBlock();
            if (block) {
                block.querySelectorAll('input[name], select[name]').forEach(el => {
                    if (el.tagName === 'SELECT') {
                        el.value = '';
                    } else if (el.type === 'date' || el.type === 'text' || el.type === 'number') {
                        el.value = '';
                    }
                });
            }

            const params = new URLSearchParams();
            params.set('Seccion', seccion);
            params.set('handler', 'Preview');
            const url = `${window.location.pathname}?${params.toString()}`;
            document.getElementById('previewFrame').src = url;
        }

        document.addEventListener('DOMContentLoaded', () => {
            onSeccionChange();
            if (document.getElementById('seccion').value) loadPreview();
        });
    </script>
}
